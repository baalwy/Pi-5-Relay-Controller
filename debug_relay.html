<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تصحيح أخطاء الريلايات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; padding: 2rem; }
        .debug-section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .log-area { height: 200px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 4px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .status-card { padding: 1rem; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        .status-on { background: #d4edda; border-color: #c3e6cb; }
        .status-off { background: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 تصحيح أخطاء نظام الريلايات</h1>
        
        <div class="debug-section">
            <h3>📊 حالة جميع الريلايات</h3>
            <button class="btn btn-primary mb-3" onclick="checkAllStatuses()">فحص جميع الحالات</button>
            <div class="status-grid" id="statusGrid"></div>
        </div>
        
        <div class="debug-section">
            <h3>🧪 اختبار ريلي واحد</h3>
            <div class="row">
                <div class="col-md-3">
                    <input type="number" class="form-control" id="testRelay" placeholder="رقم الريلي (1-16)" min="1" max="16" value="1">
                </div>
                <div class="col-md-9">
                    <button class="btn btn-success me-2" onclick="testRelay('on')">تشغيل</button>
                    <button class="btn btn-danger me-2" onclick="testRelay('off')">إيقاف</button>
                    <button class="btn btn-info me-2" onclick="testRelay('toggle')">تبديل</button>
                    <button class="btn btn-secondary" onclick="testRelay('status')">فحص الحالة</button>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>📝 سجل الأحداث</h3>
            <button class="btn btn-warning mb-2" onclick="clearLog()">مسح السجل</button>
            <div class="log-area" id="logArea"></div>
        </div>
        
        <div class="debug-section">
            <h3>🌐 اختبار الاتصال</h3>
            <button class="btn btn-info" onclick="testConnection()">اختبار الاتصال بالسيرفر</button>
            <div id="connectionStatus" class="mt-2"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const color = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
            logArea.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            logCount = 0;
        }
        
        function checkAllStatuses() {
            log('بدء فحص جميع الريلايات...');
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 16; i++) {
                const card = document.createElement('div');
                card.className = 'status-card';
                card.id = `status-card-${i}`;
                card.innerHTML = `<strong>ريلي ${i}</strong><br><span id="status-${i}">جاري الفحص...</span>`;
                grid.appendChild(card);
                
                // Check status
                $.get(`/status/${i}`)
                    .done(function(data) {
                        const isOn = parseInt(data) > 0;
                        const statusText = isOn ? 'مُشغل' : 'مُطفأ';
                        const statusClass = isOn ? 'status-on' : 'status-off';
                        
                        document.getElementById(`status-${i}`).textContent = statusText;
                        document.getElementById(`status-card-${i}`).className = `status-card ${statusClass}`;
                        
                        log(`ريلي ${i}: ${statusText}`, isOn ? 'success' : 'info');
                    })
                    .fail(function() {
                        document.getElementById(`status-${i}`).textContent = 'خطأ';
                        log(`خطأ في فحص ريلي ${i}`, 'error');
                    });
            }
        }
        
        function testRelay(action) {
            const relayNum = document.getElementById('testRelay').value;
            if (!relayNum || relayNum < 1 || relayNum > 16) {
                log('رقم ريلي غير صحيح!', 'error');
                return;
            }
            
            let url;
            switch(action) {
                case 'on':
                    url = `/on/${relayNum}`;
                    break;
                case 'off':
                    url = `/off/${relayNum}`;
                    break;
                case 'toggle':
                    url = `/toggle/${relayNum}`;
                    break;
                case 'status':
                    url = `/status/${relayNum}`;
                    break;
                default:
                    log('عملية غير صحيحة!', 'error');
                    return;
            }
            
            log(`تنفيذ ${action} على ريلي ${relayNum}...`);
            
            $.get(url)
                .done(function(data) {
                    if (action === 'status') {
                        const isOn = parseInt(data) > 0;
                        const statusText = isOn ? 'مُشغل' : 'مُطفأ';
                        log(`ريلي ${relayNum}: ${statusText}`, isOn ? 'success' : 'info');
                    } else {
                        log(`تم تنفيذ ${action} على ريلي ${relayNum} بنجاح`, 'success');
                        // Check status after action
                        setTimeout(() => {
                            $.get(`/status/${relayNum}`)
                                .done(function(statusData) {
                                    const isOn = parseInt(statusData) > 0;
                                    const statusText = isOn ? 'مُشغل' : 'مُطفأ';
                                    log(`حالة ريلي ${relayNum} بعد العملية: ${statusText}`, 'info');
                                });
                        }, 500);
                    }
                })
                .fail(function() {
                    log(`فشل في تنفيذ ${action} على ريلي ${relayNum}`, 'error');
                });
        }
        
        function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>جاري الاختبار...';
            
            $.get('/status/1')
                .done(function() {
                    statusDiv.innerHTML = '<div class="alert alert-success">✅ الاتصال بالسيرفر يعمل بشكل طبيعي</div>';
                    log('اختبار الاتصال: نجح', 'success');
                })
                .fail(function() {
                    statusDiv.innerHTML = '<div class="alert alert-danger">❌ فشل في الاتصال بالسيرفر</div>';
                    log('اختبار الاتصال: فشل', 'error');
                });
        }
        
        // Initialize
        $(document).ready(function() {
            log('تم تحميل صفحة التصحيح');
            testConnection();
        });
    </script>
</body>
</html>
